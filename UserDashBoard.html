<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8" />
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-6 space-y-8">
  <h1 class="text-3xl font-bold">ðŸ§  Speaker Stats Dashboard</h1>

  <!-- Filters -->
  <form id="filterForm" class="flex flex-wrap gap-4 items-end border-b pb-4">
    <div>
      <label class="block text-sm font-semibold">Start Date</label>
      <input type="date" id="startDate" name="start_date" class="border px-3 py-1 rounded-md">
    </div>
    <div>
      <label class="block text-sm font-semibold">End Date</label>
      <input type="date" id="endDate" name="end_date" class="border px-3 py-1 rounded-md">
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Apply</button>
  </form>

  <!-- Charts -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <canvas id="wordsChart" height="200"></canvas>
    <canvas id="fillersChart" height="200"></canvas>
    <canvas id="contributionChart" height="200"></canvas>
  </div>

  <!-- Table -->
  <div>
    <h2 class="text-xl font-semibold mt-10 mb-2">ðŸ“… Meetings Attended</h2>
    <div class="overflow-x-auto border rounded-md">
      <table class="min-w-full bg-white text-sm">
        <thead class="bg-gray-200 text-left">
          <tr>
            <th class="px-4 py-2">Meeting ID</th>
            <th class="px-4 py-2">Speaker</th>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Words</th>
            <th class="px-4 py-2">Fillers</th>
            <th class="px-4 py-2">Contribution %</th>
          </tr>
        </thead>
        <tbody id="meetingsTableBody" class="divide-y">
          <!-- Dynamic rows go here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://n8n.sapidblue.in/webhook/FirelfiesDashbaord";

    function getDefaultDates() {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);
      const format = (d) => d.toISOString().split("T")[0];
      document.getElementById("startDate").value = format(start);
      document.getElementById("endDate").value = format(end);
      return { startDate: format(start), endDate: format(end) };
    }

    async function loadDashboard(startDate, endDate) {
      const url = `${API_URL}?start_date=${startDate}&end_date=${endDate}`;
      const response = await fetch(url);
      const result = await response.json();

      const data = result.summary || result; // fallback to old shape
      const meetings = result.meetings || [];

      const labels = data.map(d => d.speaker_name);
      const words = data.map(d => parseInt(d.total_words || 0));
      const fillers = data.map(d => parseInt(d.total_fillers || 0));
      const contribution = data.map(d => parseFloat(d.avg_contribution_pct || 0).toFixed(2));

      const destroyIfExists = (id) => {
        const chart = Chart.getChart(id);
        if (chart) chart.destroy();
      };

      destroyIfExists("wordsChart");
      destroyIfExists("fillersChart");
      destroyIfExists("contributionChart");

      new Chart(document.getElementById("wordsChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Total Words",
            data: words,
            backgroundColor: "rgba(59, 130, 246, 0.6)"
          }]
        }
      });

      new Chart(document.getElementById("fillersChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Filler Words",
            data: fillers,
            backgroundColor: "rgba(234, 88, 12, 0.6)"
          }]
        }
      });

      new Chart(document.getElementById("contributionChart"), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: "% Contribution",
            data: contribution,
            borderColor: "rgba(16, 185, 129, 0.9)",
            fill: false,
            tension: 0.3
          }]
        }
      });

      // Render table rows
      const tbody = document.getElementById("meetingsTableBody");
      tbody.innerHTML = "";
      meetings.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2">${row.meeting_id}</td>
          <td class="px-4 py-2">${row.speaker_name}</td>
          <td class="px-4 py-2">${(row.updated_at || "").split("T")[0]}</td>
          <td class="px-4 py-2">${row.word_count}</td>
          <td class="px-4 py-2">${row.filler_estimate}</td>
          <td class="px-4 py-2">${row.word_contribution_pct}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      loadDashboard(startDate, endDate);
    });

    const { startDate, endDate } = getDefaultDates();
    loadDashboard(startDate, endDate);
  </script>
</body>
</html>
