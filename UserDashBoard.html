<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8" />
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-6">Speaker Stats Dashboard</h1>

  <!-- Date filter form -->
  <form id="filterForm" class="mb-6 flex gap-4 flex-wrap items-end">
    <div>
      <label class="block text-sm font-semibold">Start Date</label>
      <input type="date" id="startDate" name="start_date" class="border px-3 py-1 rounded-md">
    </div>
    <div>
      <label class="block text-sm font-semibold">End Date</label>
      <input type="date" id="endDate" name="end_date" class="border px-3 py-1 rounded-md">
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Apply</button>
  </form>

  <!-- Charts -->
  <canvas id="wordsChart" class="mb-6 max-w-full"></canvas>
  <canvas id="fillersChart" class="mb-6 max-w-full"></canvas>
  <canvas id="contributionChart" class="mb-6 max-w-full"></canvas>

  <script>
    const API_URL = "https://n8n.sapidblue.in/webhook/FirelfiesDashbaord";

    // Set default dates (last 30 days)
    function getDefaultDates() {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);

      const format = (d) => d.toISOString().split("T")[0];

      document.getElementById("startDate").value = format(start);
      document.getElementById("endDate").value = format(end);

      return { startDate: format(start), endDate: format(end) };
    }

    // Fetch and render dashboard
    async function loadDashboard(startDate, endDate) {
      const url = `${API_URL}?start_date=${startDate}&end_date=${endDate}`;
      const response = await fetch(url);
      const data = await response.json();

      const labels = data.map(d => d.speaker_name);
      const words = data.map(d => parseInt(d.total_words || 0));
      const fillers = data.map(d => parseInt(d.total_fillers || 0));
      const contribution = data.map(d => parseFloat(d.avg_contribution_pct || 0).toFixed(2));

      const destroyIfExists = (id) => {
        const chart = Chart.getChart(id);
        if (chart) chart.destroy();
      };

      destroyIfExists("wordsChart");
      destroyIfExists("fillersChart");
      destroyIfExists("contributionChart");

      new Chart(document.getElementById("wordsChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Total Words",
            data: words,
            backgroundColor: "rgba(59, 130, 246, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Total Words per Speaker' }
          }
        }
      });

      new Chart(document.getElementById("fillersChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Filler Words",
            data: fillers,
            backgroundColor: "rgba(234, 88, 12, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Filler Words per Speaker' }
          }
        }
      });

      new Chart(document.getElementById("contributionChart"), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: "% Contribution",
            data: contribution,
            borderColor: "rgba(16, 185, 129, 0.9)",
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: '% Word Contribution per Speaker' }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    // Handle form submit
    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      loadDashboard(startDate, endDate);
    });

    // Load dashboard on first load
    const { startDate, endDate } = getDefaultDates();
    loadDashboard(startDate, endDate);
  </script>
</body>
</html>
