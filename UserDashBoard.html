<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8" />
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-6">Speaker Stats Dashboard</h1>

  <!-- Date filter form -->
  <form id="filterForm" class="mb-6 flex gap-4 flex-wrap items-end">
    <div>
      <label class="block text-sm font-semibold">Start Date</label>
      <input type="date" id="startDate" name="start_date" class="border px-3 py-1 rounded-md">
    </div>
    <div>
      <label class="block text-sm font-semibold">End Date</label>
      <input type="date" id="endDate" name="end_date" class="border px-3 py-1 rounded-md">
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md">Apply</button>
  </form>

  <!-- Dashboard Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div class="bg-white p-4 rounded shadow">
      <canvas id="wordsChart" class="w-full h-48"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <canvas id="fillersChart" class="w-full h-48"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <canvas id="contributionChart" class="w-full h-48"></canvas>
    </div>
  </div>

  <!-- Meeting List -->
  <div class="mt-6 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-3">Meetings Attended</h2>
    <div id="meetingList" class="text-sm space-y-2"></div>
  </div>

  <script>
    const API_URL = "https://n8n.sapidblue.in/webhook/FirelfiesDashbaord";

    function getDefaultDates() {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);
      const format = d => d.toISOString().split("T")[0];
      document.getElementById("startDate").value = format(start);
      document.getElementById("endDate").value = format(end);
      return { startDate: format(start), endDate: format(end) };
    }

    async function loadDashboard(startDate, endDate) {
      const url = `${API_URL}?start_date=${startDate}&end_date=${endDate}`;
      const response = await fetch(url);
      const data = await response.json();

      const summaryData = data.filter(d => d.meetings_attended !== undefined);
      const meetingData = data.filter(d => d.meeting_id !== undefined);

      const labels = summaryData.map(d => d.speaker_name);
      const words = summaryData.map(d => d.total_words);
      const fillers = summaryData.map(d => d.total_fillers);
      const contribution = summaryData.map(d => parseFloat(d.avg_contribution_pct));

      const destroyIfExists = (id) => {
        const chart = Chart.getChart(id);
        if (chart) chart.destroy();
      };

      destroyIfExists("wordsChart");
      destroyIfExists("fillersChart");
      destroyIfExists("contributionChart");

      new Chart(document.getElementById("wordsChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Total Words",
            data: words,
            backgroundColor: "rgba(59, 130, 246, 0.6)"
          }]
        }
      });

      new Chart(document.getElementById("fillersChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: "Filler Words",
            data: fillers,
            backgroundColor: "rgba(234, 88, 12, 0.6)"
          }]
        }
      });

      new Chart(document.getElementById("contributionChart"), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: "% Contribution",
            data: contribution,
            borderColor: "rgba(16, 185, 129, 0.9)",
            fill: false
          }]
        }
      });

      // Render meeting list
      const listContainer = document.getElementById("meetingList");
      listContainer.innerHTML = meetingData.map(m => 
        `<div class="border p-2 rounded">
          <strong>${m.speaker_name}</strong> (${m.email}) â€” Meeting: <code>${m.meeting_id}</code><br>
          Words: ${m.word_count}, Fillers: ${m.filler_estimate}, Contribution: ${m.word_contribution_pct}%
        </div>`
      ).join("");
    }

    document.getElementById("filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      loadDashboard(startDate, endDate);
    });

    const { startDate, endDate } = getDefaultDates();
    loadDashboard(startDate, endDate);
  </script>
</body>
</html>
