<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8" />
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas { max-height: 160px !important; }
  </style>
</head>
<body class="p-6 max-w-7xl mx-auto space-y-8">
  <h1 class="text-3xl font-bold text-center">üî• Fireflies Speaker Dashboard</h1>

  <!-- Date Filter -->
  <form id="filterForm" class="flex flex-wrap justify-center gap-6 items-end">
    <div>
      <label class="block text-sm font-semibold mb-1">Start Date</label>
      <input type="date" id="startDate" class="border px-3 py-1 rounded-md" />
    </div>
    <div>
      <label class="block text-sm font-semibold mb-1">End Date</label>
      <input type="date" id="endDate" class="border px-3 py-1 rounded-md" />
    </div>
    <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-md">Apply</button>
  </form>

  <!-- Compliance Chart -->
  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-semibold mb-2 text-center">Compliance Scores</h3>
    <canvas id="complianceChart" width="400" height="150"></canvas>
  </div>

  <!-- Filler Percentage Table -->
  <div class="bg-white p-4 rounded shadow overflow-x-auto text-sm">
    <h3 class="font-semibold mb-2">Filler Word Percentage</h3>
    <table class="min-w-full border border-gray-300">
      <thead class="bg-gray-100"><tr>
        <th class="border px-3 py-1 text-left">Speaker</th>
        <th class="border px-3 py-1 text-left">Words</th>
        <th class="border px-3 py-1 text-left">Fillers</th>
        <th class="border px-3 py-1 text-left">Filler %</th>
      </tr></thead>
      <tbody id="fillerTableBody"></tbody>
    </table>
  </div>

  <!-- Meeting Cards -->
  <div id="meetingCards" class="space-y-6"></div>

  <script>
    const COMPLIANCE_URL = "https://n8n.sapidblue.in/webhook/compliance-scores";

    // Set default 30-day range
    const { startDate, endDate } = (() => {
      const end = new Date(), start = new Date();
      start.setDate(end.getDate() - 30);
      const fmt = d => d.toISOString().split("T")[0];
      document.getElementById("startDate").value = fmt(start);
      document.getElementById("endDate").value = fmt(end);
      return { startDate: fmt(start), endDate: fmt(end) };
    })();

    async function loadDashboard(sd, ed) {
      const resp = await fetch(`${COMPLIANCE_URL}?start_date=${sd}&end_date=${ed}`);
      const data = await resp.json();

      // Group per speaker & per meeting
      const perSpeaker = {}, meetings = {};
      data.forEach(e => {
        // per-speaker
        if (!perSpeaker[e.speaker_name]) perSpeaker[e.speaker_name] = { totalScore:0, count:0, words:0, fillers:0 };
        const minScore = (e.word_count < 10) ? 0 : e.score;
        perSpeaker[e.speaker_name].totalScore += minScore;
        perSpeaker[e.speaker_name].count++;
        perSpeaker[e.speaker_name].words += e.word_count;
        perSpeaker[e.speaker_name].fillers += e.filler_estimate;

        // per meeting
        if (!meetings[e.meeting_id]) meetings[e.meeting_id] = [];
        meetings[e.meeting_id].push(e);
      });

      // Render compliance chart
      const speakers = Object.keys(perSpeaker);
      const complianceValues = speakers.map(s => (perSpeaker[s].totalScore / perSpeaker[s].count).toFixed(1));
      new Chart(document.getElementById("complianceChart"), {
        type: 'bar',
        data: { labels: speakers, datasets:[{ label:"Compliance", data: complianceValues, backgroundColor:"#3B82F6" }] },
        options: { scales:{ y: { beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } } }
      });

      // Render filler table
      document.getElementById("fillerTableBody").innerHTML = "";
      speakers.forEach(s => {
        const st = perSpeaker[s];
        const pct = st.words ? ((st.fillers/st.words)*100).toFixed(2) : "0.00";
        document.getElementById("fillerTableBody").innerHTML += `
          <tr>
            <td class="border px-3 py-2">${s}</td>
            <td class="border px-3 py-2">${st.words}</td>
            <td class="border px-3 py-2">${st.fillers}</td>
            <td class="border px-3 py-2">${pct}%</td>
          </tr>`;
      });

      // Render meeting cards
      const container = document.getElementById("meetingCards");
      container.innerHTML = "";
      for (const [meetId, arr] of Object.entries(meetings)) {
        let html = `<div class="bg-white p-4 rounded shadow"><h3 class="font-semibold mb-2">Meeting: ${meetId}</h3>`;
        arr.forEach(e => {
          const fillerPct = e.word_count ? ((e.filler_estimate/e.word_count)*100).toFixed(2) : "0.00";
          const comp = e.word_count < 10 ? 0 : e.score;
          html += `<div class="border-t pt-2 mt-2">
            <strong>${e.speaker_name}</strong><br>
            Words: ${e.word_count}, Fillers: ${e.filler_estimate}, Filler %: ${fillerPct}%<br>
            Contribution: ${e.word_contribution_pct}%<br>
            Compliance: ${comp}<br>
            <em>‚úîÔ∏è Matched:</em> ${e.matched_topics || "‚Äì"}<br>
            <em>‚ùå Missed:</em> ${e.missed_topics || "‚Äì"}
          </div>`;
        });
        html += `</div>`;
        container.innerHTML += html;
      }
    }

    document.getElementById("filterForm").addEventListener("submit", e => {
      e.preventDefault();
      loadDashboard(document.getElementById("startDate").value, document.getElementById("endDate").value);
    });

    loadDashboard(startDate, endDate);
  </script>
</body>
</html>
