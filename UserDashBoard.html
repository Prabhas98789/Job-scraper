<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8"/>
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas { max-height: 200px !important; }
    .card { background: #fff; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="p-6 max-w-7xl mx-auto space-y-10">

  <h1 class="text-3xl font-bold text-center">üî• Fireflies Speaker Dashboard</h1>

  <!-- Filter -->
  <form id="filterForm" class="flex flex-wrap justify-center gap-6 items-end">
    <div><label>Start Date</label><input type="date" id="startDate" class="border px-3 py-1 rounded"/></div>
    <div><label>End Date</label><input type="date" id="endDate" class="border px-3 py-1 rounded"/></div>
    <button class="bg-blue-600 text-white px-5 py-2 rounded">Apply</button>
  </form>

  <!-- Total Compliance Bar -->
  <div class="card">
    <h3 class="font-semibold text-center">Total Compliance Scores</h3>
    <canvas id="totalComplianceChart"></canvas>
  </div>

  <!-- Date-Filtered Compliance Chart -->
  <div class="card">
    <h3 class="font-semibold text-center">Filtered Compliance Scores</h3>
    <canvas id="complianceChart"></canvas>
  </div>

  <!-- Filler Word Table -->
  <div class="card overflow-x-auto">
    <h3 class="font-semibold">Filler Word Percentage</h3>
    <table class="min-w-full text-sm">
      <thead><tr><th>Speaker</th><th>Words</th><th>Fillers</th><th>Filler %</th></tr></thead>
      <tbody id="fillerPercentBody"></tbody>
    </table>
  </div>

  <!-- Trend Chart per Speaker -->
  <div class="card">
    <h3 class="font-semibold">Word Trend (per Meeting)</h3>
    <canvas id="wordTrendContainer"></canvas>
  </div>

  <!-- Stacked Words -->
  <div class="card">
    <h3 class="font-semibold">Stacked Words vs Fillers</h3>
    <canvas id="stackedChart"></canvas>
  </div>

  <!-- Individual Speaker Cards -->
  <div id="userCards" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

  <!-- Meeting Cards -->
  <div id="meetingCards" class="space-y-6"></div>

<script>
  const urls = {
    totalCompliance: 'https://n8n.sapidblue.in/webhook/t_data',
    filteredCompliance: 'https://n8n.sapidblue.in/webhook/compliance-scores',
    fillerPercent: 'https://n8n.sapidblue.in/webhook/fillerpercent',
    wordTrend: 'https://n8n.sapidblue.in/webhook/word-trend-stats',
    totalInRegion: 'https://n8n.sapidblue.in/webhook/totalinaregion',
    userData: 'https://n8n.sapidblue.in/webhook/t_user_Data',
    meetingData: 'https://n8n.sapidblue.in/webhook/FirelfiesDashbaord'
  };

  function setDefaultDates() {
    const end=new Date(), start=new Date();
    start.setDate(end.getDate()-30);
    const f=d=>d.toISOString().split('T')[0];
    document.getElementById('startDate').value=f(start);
    document.getElementById('endDate').value=f(end);
    return { start:f(start), end:f(end) };
  }

  async function drawChart(ctxId, type, data, options={}) {
    const ctx = document.getElementById(ctxId).getContext('2d');
    if (ctx.chart) ctx.chart.destroy();
    ctx.chart = new Chart(ctx, { type, data, options });
  }

  async function loadDashboard(start, end) {
    const [
      totCompr, filtCompr, filler, trend, stacked, usrData, meetData
    ] = await Promise.all([
      fetch(urls.totalCompliance).then(r=>r.json()),
      fetch(`${urls.filteredCompliance}?start_date=${start}&end_date=${end}`).then(r=>r.json()),
      fetch(`${urls.fillerPercent}?start_date=${start}&end_date=${end}`).then(r=>r.json()),
      fetch(`${urls.wordTrend}?start_date=${start}&end_date=${end}`).then(r=>r.json()),
      fetch(`${urls.totalInRegion}?start_date=${start}&end_date=${end}`).then(r=>r.json()),
      fetch(urls.userData).then(r=>r.json()),
      fetch(`${urls.meetingData}?start_date=${start}&end_date=${end}`).then(r=>r.json())
    ]);

    // total compliance
    await drawChart('totalComplianceChart', 'bar', {
      labels: totCompr.map(o=>o.speaker_name),
      datasets: [{ label:'Avg Compliance', data: totCompr.map(o=>o.avg_compliance_score), backgroundColor:'#10B981' }]
    }, { scales:{y:{beginAtZero:true, max:100}}, plugins:{legend:{display:false}} });

    // filtered compliance
    await drawChart('complianceChart', 'bar', {
      labels: filtCompr.map(o=>o.speaker_name),
      datasets: [{ label:'Filtered Score', data: filtCompr.map(o=>o.score), backgroundColor:'#3B82F6' }]
    }, { scales:{y:{beginAtZero:true, max:100}}, plugins:{legend:{display:false}} });

    // filler percentage table
    const fp = filler;
    document.getElementById('fillerPercentBody').innerHTML = fp.map(o=>`
      <tr><td>${o.speaker_name}</td><td>${o.word_count}</td><td>${o.total_fillers}</td><td>${o.filler_percent}%</td></tr>`).join('');

    // word trend chart
    const labelsTrend = trend.map(o=>o.meeting_id);
    const dataTrend = trend.map(o=>o.total_words);
    await drawChart('wordTrendContainer','line',{
      labels: labelsTrend, datasets:[{ label:'Words', data:dataTrend, borderColor:'#3B82F6', tension:0.3 }]
    }, { scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'bottom'}} });

    // stacked chart
    await drawChart('stackedChart','bar',{
      labels: stacked.map(o=>o.speaker_name),
      datasets:[
        { label:'Words', data:stacked.map(o=>o.total_words), backgroundColor:'#3B82F6' },
        { label:'Fillers', data:stacked.map(o=>o.total_fillers), backgroundColor:'#F97316' }
      ]
    }, { scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}, plugins:{legend:{position:'bottom'}} });

    // user cards
    const userCards = document.getElementById('userCards');
    userCards.innerHTML = usrData.map(o=>`
      <div class="card">
        <h4 class="font-semibold">${o.speaker_name}</h4>
        <p>Words: ${o.word_count}</p>
        <p>Fillers: ${o.filler_words}</p>
        <p>Filler %: ${o.filler_words && o.word_count ? ((o.filler_words/o.word_count)*100).toFixed(2) : '0.00'}%</p>
        <p>Avg Contribution: ${o.avg_contribution_pct}%</p>
        <p>Avg Compliance: ${o.avg_compliance_score}%</p>
      </div>`).join('');

    // meeting cards
    const meetCards = document.getElementById('meetingCards');
    meetCards.innerHTML = '';
    const grouped = {};
    meetData.filter(x=>x.meeting_id).forEach(o=> {
      grouped[o.meeting_id] = grouped[o.meeting_id]||[];
      grouped[o.meeting_id].push(o);
    });
    Object.entries(grouped).forEach(([mid, arr])=>{
      const items = arr.filter((v,i,self)=>
        self.findIndex(x=>x.speaker_name===v.speaker_name && x.email===v.email)===i
      );
      let html = `<div class="card"><h4 class="font-semibold">Meeting: ${mid}</h4>`;
      items.forEach(o=>{
        const fPct = o.word_count ? ((o.filler_estimate/o.word_count)*100).toFixed(2) : '0.00';
        html += `<div class="border p-2 mb-2">
          <strong>${o.speaker_name}</strong><br/>
          Words: ${o.word_count} ‚Ä¢ Fillers: ${o.filler_estimate} ‚Ä¢ Filler %: ${fPct}%<br/>
          Contribution: ${o.word_contribution_pct}% ‚Ä¢ Compliance: ${o.score}%<br/>
          ‚úîÔ∏è Matched: ${o.matched_topics||'N/A'}<br/>
          ‚ùå Missed: ${o.missed_topics||'N/A'}
        </div>`;
      });
      html += `</div>`;
      meetCards.insertAdjacentHTML('beforeend', html);
    });
  }

  document.getElementById('filterForm').addEventListener('submit', e=>{
    e.preventDefault();
    const s = document.getElementById('startDate').value;
    const e2 = document.getElementById('endDate').value;
    loadDashboard(s, e2);
  });

  const { start, end } = setDefaultDates();
  loadDashboard(start, end);

</script>
</body>
</html>
