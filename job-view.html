<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job View Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="p-6" x-data="jobViewPage()" x-init="fetchJob()">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">

    <button 
      @click="goBack()" 
      class="mb-4 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
    >
      ‚Üê Back
    </button>

    <h1 class="text-3xl font-bold mb-4" x-text="job.title || 'Loading...'"></h1>

    <div class="flex space-x-6">
      <div class="w-32 h-32 flex-shrink-0">
        <img :src="job.companyLogo" alt="Company Logo" class="object-contain w-full h-full rounded" />
      </div>
      <div class="flex-1 space-y-2">
        <p><strong>Company:</strong> <a :href="job.companyLinkedinUrl" target="_blank" class="text-blue-600 hover:underline" x-text="job.companyName"></a></p>
        <p><strong>Location:</strong> <span x-text="job.location"></span></p>
        <p><strong>Posted At:</strong> <span x-text="job.postedAt"></span></p>
        <p><strong>Seniority Level:</strong> <span x-text="job.seniorityLevel"></span></p>
        <p><strong>Employment Type:</strong> <span x-text="job.employmentType"></span></p>
        <p><strong>Job Function:</strong> <span x-text="job.jobFunction"></span></p>
        <p><strong>Industries:</strong> <span x-text="job.industries"></span></p>
        <p><strong>Employees:</strong> <span x-text="job.companyEmployeesCount"></span></p>
        <p><strong>Company Website:</strong> 
          <a :href="job.companyWebsite" target="_blank" class="text-blue-600 hover:underline" x-text="job.companyWebsite"></a>
        </p>
        <p><strong>Job Posting:</strong> 
          <a :href="job.link" target="_blank" class="text-blue-600 hover:underline">View on LinkedIn</a>
        </p>
      </div>
    </div>

    <div class="mt-6">
      <label for="description" class="block font-medium mb-1">Job Description</label>
      <textarea id="description" x-model="job.descriptionText" rows="8" class="w-full border rounded p-2 text-sm"></textarea>
    </div>

    <div class="mt-6 flex space-x-4 justify-end">
      <button
        @click="saveJob()"
        :disabled="loading"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
      >Save</button>

      <button
        @click="deleteJob()"
        :disabled="loading"
        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
      >Delete</button>
    </div>

  </div>

  <script>
    function jobViewPage() {
      return {
        job: {},
        loading: false,
        sequence_id: null,
        id: null,

        fetchJob() {
          const urlParams = new URLSearchParams(window.location.search);
          this.sequence_id = urlParams.get('sequence_id');
          this.id = urlParams.get('id');

          if (!this.sequence_id || !this.id) {
            alert('Missing sequence_id or job id');
            return;
          }

          fetch('https://n8n.sapidblue.in/webhook/view-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.id, sequence_id: this.sequence_id })
          })
          .then(res => res.json())
          .then(data => {
            if (data && data.id) {
              this.job = data;
              // ensure both IDs are in job object for save/delete
              this.job.sequence_id = this.sequence_id;
              this.job.id = this.id;
            } else {
              alert('Job not found');
            }
          })
          .catch(() => alert('Failed to fetch job details'));
        },

        saveJob() {
          this.loading = true;
          fetch('https://n8n.sapidblue.in/webhook/edit-data-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.job)
          })
          .then(res => res.json())
          .then(resp => {
            alert(resp.success ? 'Saved successfully' : 'Failed to save');
          })
          .catch(() => alert('Error saving job data'))
          .finally(() => this.loading = false);
        },

        deleteJob() {
          if (!confirm('Are you sure you want to delete this job?')) return;

          this.loading = true;
          fetch('https://n8n.sapidblue.in/webhook/delete-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.id, sequence_id: this.sequence_id })
          })
          .then(res => res.json())
          .then(resp => {
            if (resp.success) {
              alert('Deleted successfully');
              this.goBack();
            } else {
              alert('Failed to delete');
            }
          })
          .catch(() => alert('Error deleting job'))
          .finally(() => this.loading = false);
        },

        goBack() {
          window.history.back();
        }
      }
    }
  </script>
</body>
</html>
