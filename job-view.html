<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job View Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="p-6" x-data="jobViewPage()" x-init="fetchJob()">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">

    <button 
      @click="goBack()" 
      class="mb-4 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
    >
      ‚Üê Back
    </button>

    <h1 class="text-3xl font-bold mb-4" x-text="job.title || 'Loading...'"></h1>

    <div class="flex space-x-6">
      <div class="w-32 h-32 flex-shrink-0">
        <img :src="job.companyLogo" alt="Company Logo" class="object-contain w-full h-full rounded" />
      </div>
      <div class="flex-1 space-y-2">
        <p><strong>Company:</strong> 
          <a :href="job.companyLinkedinUrl" target="_blank" class="text-blue-600 hover:underline" x-text="job.companyName"></a>
        </p>
        <p><strong>Location:</strong> <span x-text="job.location"></span></p>
        <p><strong>Posted At:</strong> <span x-text="job.postedAt"></span></p>
        <p><strong>Seniority Level:</strong> <span x-text="job.seniorityLevel"></span></p>
        <p><strong>Employment Type:</strong> <span x-text="job.employmentType"></span></p>
        <p><strong>Job Function:</strong> <span x-text="job.jobFunction"></span></p>
        <p><strong>Industries:</strong> <span x-text="job.industries"></span></p>
        <p><strong>Employees:</strong> <span x-text="job.companyEmployeesCount"></span></p>
        <p><strong>Company Website:</strong> 
          <a :href="job.companyWebsite" target="_blank" class="text-blue-600 hover:underline" x-text="job.companyWebsite"></a>
        </p>
        <p><strong>Job Posting:</strong> 
          <a :href="job.link" target="_blank" class="text-blue-600 hover:underline">View on LinkedIn</a>
        </p>
      </div>
    </div>

    <div class="mt-6">
      <label for="description" class="block font-medium mb-1">Job Description</label>
      <textarea id="description" x-model="job.descriptionText" rows="8" class="w-full border rounded p-2 text-sm"></textarea>
    </div>

    <div class="mt-6 flex space-x-4 justify-end">
      <button
        @click="saveJob()"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
      >Save</button>

      <button
        @click="deleteJob()"
        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
      >Delete</button>
    </div>

  </div>

  <script>
    function jobViewPage() {
      return {
        job: {},
        jobId: null,
        sequenceId: null,

        fetchJob() {
          const urlParams = new URLSearchParams(window.location.search);
          this.jobId = urlParams.get('id');
          this.sequenceId = urlParams.get('sequence_id');
          if (!this.jobId || !this.sequenceId) {
            alert('Job id or sequence id missing in URL');
            return;
          }

          fetch('https://n8n.sapidblue.in/webhook/view-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.jobId, sequence_id: this.sequenceId })
          })
            .then(res => res.json())
            .then(data => {
              if (data && data.id) {
                this.job = data;
              } else {
                alert('Job not found');
              }
            })
            .catch(() => alert('Failed to fetch job details'));
        },

        saveJob() {
          if (!this.jobId || !this.sequenceId) {
            alert('Missing job id or sequence id');
            return;
          }
          const payload = { ...this.job, id: this.jobId, sequence_id: this.sequenceId };

          fetch('https://n8n.sapidblue.in/webhook/edit-data-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then(res => res.json())
            .then(resp => {
              alert(resp.success ? 'Saved successfully' : 'Failed to save');
            })
            .catch(() => alert('Error saving job data'));
        },

        deleteJob() {
          if (!confirm('Are you sure you want to delete this job?')) return;

          if (!this.jobId || !this.sequenceId) {
            alert('Missing job id or sequence id');
            return;
          }

          fetch('https://n8n.sapidblue.in/webhook/delete-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.jobId, sequence_id: this.sequenceId })
          })
            .then(res => res.json())
            .then(resp => {
              if (resp.success) {
                alert('Deleted successfully');
                this.goBack();
              } else {
                alert('Failed to delete');
              }
            })
            .catch(() => alert('Error deleting job'));
        },

        goBack() {
          if (this.sequenceId) {
            window.location.href = `job-detail.html?id=${this.sequenceId}`;
          } else {
            window.history.back();
          }
        }
      }
    }
  </script>
</body>
</html>
