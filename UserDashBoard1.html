<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">
<head>
  <meta charset="UTF-8"/>
  <title>Fireflies Speaker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas { max-height: 300px; }
    .card { background:#fff; padding:1rem; border-radius:.5rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .reload-btn { font-size:.875rem; color:#2563EB; cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body class="p-6 max-w-7xl mx-auto space-y-8">

<h1 class="text-4xl font-bold text-center">ðŸ”¥ Fireflies Speaker Dashboard</h1>
<div id="summaryBox" class="text-center text-sm text-gray-600 mt-1"></div>

<!-- Date Filter -->
<form id="filterForm" class="flex flex-wrap justify-center gap-6 items-end">
  <label class="flex flex-col">
    <span>Start Date</span>
    <input type="date" id="startDate" class="border px-3 py-1 rounded"/>
  </label>
  <label class="flex flex-col">
    <span>End Date</span>
    <input type="date" id="endDate" class="border px-3 py-1 rounded"/>
  </label>
  <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded">Apply</button>
</form>

<!-- Speaker Meeting Count Table -->
<div class="card col-span-full overflow-x-auto">
  <div class="flex justify-between mb-2">
    <h3 class="font-semibold">ðŸ“‹ Speaker Meeting Counts</h3>
    <span class="reload-btn" onclick="reload('lifecycle')">â†» Reload</span>
  </div>
  <table class="min-w-full text-sm border">
    <thead class="bg-gray-100">
      <tr>
        <th class="border px-3 py-2">Speaker</th>
        <th class="border px-3 py-2">Email</th>
        <th class="border px-3 py-2">Total Unique Meetings</th>
        <th class="border px-3 py-2">Meetings in Selected Range</th>
      </tr>
    </thead>
    <tbody id="speakerMeetingTableBody"></tbody>
  </table>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="card">
    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">Compliance: Total vs Filtered</h3>
      <span class="reload-btn" onclick="reload('combined')">â†» Reload</span>
    </div>
    <canvas id="combinedComplianceChart"></canvas>
  </div>

  <div class="card">
    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">Stacked Words vs Fillers</h3>
      <span class="reload-btn" onclick="reload('stacked')">â†» Reload</span>
    </div>
    <canvas id="stackedChart"></canvas>
  </div>

  <div class="card col-span-full overflow-x-auto">
    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">Filler Word %</h3>
      <span class="reload-btn" onclick="reload('filler')">â†» Reload</span>
    </div>
    <table class="min-w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-3 py-2">Speaker</th>
          <th class="border px-3 py-2">Words</th>
          <th class="border px-3 py-2">Fillers</th>
          <th class="border px-3 py-2">Filler %</th>
          <th class="border px-3 py-2">Avg Compliance Score</th>
        </tr>
      </thead>
      <tbody id="fillerBody"></tbody>
    </table>
  </div>

  <div class="card col-span-full">
    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">Word Trends (Per Speaker)</h3>
      <span class="reload-btn" onclick="reload('trend')">â†» Reload</span>
    </div>
    <div id="trendContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <div class="card col-span-full">
    <div class="flex justify-between mb-2">
      <h3 class="font-semibold">ðŸŽ¯ Meeting-specific Speaker Compliance</h3>
      <span class="reload-btn" onclick="reload('lifecycle')">â†» Reload</span>
    </div>
    <div id="meetingCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>

<script>
const endpoints = {
  combined: 'https://n8n.sapidblue.in/webhook/t_data',
  filtered: 'https://n8n.sapidblue.in/webhook/compliance-scores',
  filler: 'https://n8n.sapidblue.in/webhook/fillerpercent',
  trend: 'https://n8n.sapidblue.in/webhook/word-trend-stats',
  stacked: 'https://n8n.sapidblue.in/webhook/totalinaregion',
  lifecycle: 'https://n8n.sapidblue.in/webhook/metings',
};

let filters = { start: '', end: '' };

function setDefaultDates(){
  const now = new Date(), prev = new Date();
  prev.setDate(now.getDate() - 30);
  const fmt = d => d.toISOString().split('T')[0];
  document.getElementById('startDate').value = filters.start = fmt(prev);
  document.getElementById('endDate').value = filters.end = fmt(now);
}

function reload(type){
  switch(type){
    case 'combined': loadCombined(); break;
    case 'stacked': loadStacked(); break;
    case 'filler': loadFiller(); break;
    case 'trend': loadTrend(); break;
    case 'lifecycle': loadLifecycle(); break;
  }
}

async function loadLifecycle(){
  const arr = await fetch(endpoints.lifecycle).then(r => r.json());
  const container = document.getElementById('meetingCards');
  const summaryBox = document.getElementById('summaryBox');
  const speakerTableBody = document.getElementById('speakerMeetingTableBody');
  container.innerHTML = '';
  speakerTableBody.innerHTML = '';
  summaryBox.textContent = `ðŸ“Š Showing unique meeting counts based on selected date range (${filters.start} to ${filters.end})`;

  const speakerMeetingMap = {};
  const speakerMonthlyMeetingMap = {};
  const speakerMeta = {};
  const startDate = new Date(filters.start);
  const endDate = new Date(filters.end);

  arr.forEach(o => {
    const speakerKey = o.email || o.speaker_name;
    if (!speakerMeetingMap[speakerKey]) speakerMeetingMap[speakerKey] = new Set();
    speakerMeetingMap[speakerKey].add(o.meeting_id);

    const meetingDate = new Date(o.date || o.timestamp || o.created_at || o.updated_at || Date.now());
    if (meetingDate >= startDate && meetingDate <= endDate) {
      if (!speakerMonthlyMeetingMap[speakerKey]) speakerMonthlyMeetingMap[speakerKey] = new Set();
      speakerMonthlyMeetingMap[speakerKey].add(o.meeting_id);
    }

    if (!speakerMeta[speakerKey]) {
      speakerMeta[speakerKey] = { name: o.speaker_name, email: o.email || 'â€”' };
    }
  });

  Object.keys(speakerMeta).forEach(key => {
    const meta = speakerMeta[key];
    const total = speakerMeetingMap[key]?.size || 0;
    const range = speakerMonthlyMeetingMap[key]?.size || 0;
    speakerTableBody.innerHTML += `<tr>
      <td class="border px-3 py-1">${meta.name}</td>
      <td class="border px-3 py-1">${meta.email}</td>
      <td class="border px-3 py-1 text-center">${total}</td>
      <td class="border px-3 py-1 text-center">${range}</td>
    </tr>`;
  });

  const grouped = {};
  arr.forEach(o => {
    if (!grouped[o.meeting_id]) grouped[o.meeting_id] = [];
    grouped[o.meeting_id].push(o);
  });

  for (const [meetingId, speakers] of Object.entries(grouped)) {
    const outer = document.createElement('div');
    outer.className = 'card space-y-3';
    outer.innerHTML = `
      <div class="flex justify-between items-center">
        <h4 class="font-bold text-lg text-indigo-600">ðŸ“Œ Meeting ID: ${meetingId}</h4>
        <a href="https://prabhas98789.github.io/Job-scraper/meet.html?meeting_id=${meetingId}" target="_blank"
           class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-1 rounded">View</a>
      </div>`;
    speakers.forEach(item => {
      const speakerCard = document.createElement('div');
      speakerCard.className = 'border p-3 rounded bg-gray-50';
      speakerCard.innerHTML = `
        <div class="font-semibold text-blue-700">${item.speaker_name} (${item.email || 'no email'})</div>
        <div><strong>Compliance Score:</strong> ${item.score}</div>
        <div><strong>Matched Topics:</strong> ${item.matched_topics || 'None'}</div>
        <div><strong>Missed Topics:</strong> ${item.missed_topics || 'None'}</div>
        <div><strong>Matched Keywords:</strong> ${item.matched?.length ? item.matched.join(', ') : 'None'}</div>
        <div><strong>Unmatched Keywords:</strong> ${item.unmatched?.length ? item.unmatched.join(', ') : 'None'}</div>
      `;
      outer.appendChild(speakerCard);
    });
    container.appendChild(outer);
  }
}

// Keep your existing loadCombined, loadStacked, loadFiller, loadTrend, renderChart functions unchanged here...

document.getElementById('filterForm').addEventListener('submit', e => {
  e.preventDefault();
  filters.start = document.getElementById('startDate').value;
  filters.end = document.getElementById('endDate').value;
  ['combined', 'stacked', 'filler', 'trend', 'lifecycle'].forEach(reload);
});

setDefaultDates();
['combined', 'stacked', 'filler', 'trend', 'lifecycle'].forEach(reload);
</script>
</body>
</html>
